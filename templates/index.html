<!DOCTYPE html>
  <!-- TEMPLATE VERSION: neon-v2 -->
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>FinanceTracker</title>
        <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/darkly/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}">
        
    </head>
    <body>
        <div class="container py-4">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h1 class="h3 mb-1">FinanceTracker</h1>
              <p class="text-secondary mb-0">Dark finance dashboard</p>
            </div>
          </div>

          <div class="row g-4">
            <div class="col-12 col-lg-5">
              <div class="neon-panel neon-green h-100" id="stocksCard">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h2 class="h4 mb-1">Stocks</h2>
                      <p class="text-secondary mb-0">Track positions, value, and performance.</p>
                    </div>
                    <div class="fs-3 text-success">
                      <i class="bi bi-graph-up-arrow"></i>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-3 mb-3 bull-bear-actions">
                    <img src="{{ url_for('static', filename='images/bull-bear.gif') }}" alt="Bull and bear" class="bull-bear-gif">
                    <button class="btn btn-success bull-bear-btn" onclick="window.location.href='/dashboard/stocks_dash/'">
                      <i class="bi bi-bar-chart-line me-2"></i>View Stocks
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <button id="linkButton" class="btn btn-outline-light btn-sm">
                      <i class="bi bi-link-45deg me-1"></i>Connect Plaid
                    </button>
                    <small class="text-secondary">Private, local-only import.</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-7">
              <div class="neon-panel neon-yellow h-100" id="cryptoCorner">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h2 class="h4 mb-1">Crypto Corner</h2>
                      <p class="text-secondary mb-0">Umbrel node health & Lightning status.</p>
                    </div>
                    <div class="fs-3 text-warning">
                      <i class="bi bi-currency-bitcoin"></i>
                      <i class="bi bi-coin ms-1"></i>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Block Count</div>
                        <div class="metric-value" id="blockcount">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Network Hash Rate</div>
                        <div class="metric-value" id="networkhashps">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Mempool Txns</div>
                        <div class="metric-value" id="mempoolinfo">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Fee Estimate (6 blocks)</div>
                        <div class="metric-value" id="estimatesmartfee">Loading...</div>
                      </div>
                    </div>
                  </div>

                  <hr class="border-secondary my-4">

                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h3 class="h5 mb-0">Umbrel Lightning</h3>
                    <span class="badge bg-warning-subtle text-warning-emphasis">Live</span>
                  </div>
                  <div class="row g-3">
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Node Alias</div>
                        <div class="metric-value" id="lightningAlias">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Block Height</div>
                        <div class="metric-value" id="lightningBlockHeight">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Active Channels</div>
                        <div class="metric-value" id="lightningChannels">Loading...</div>
                      </div>
                    </div>
                  </div>

                  <hr class="border-secondary my-4">

                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h3 class="h5 mb-0">Cold Storage</h3>
                    <span class="badge bg-success-subtle text-success-emphasis" id="coldStorageStatus">Local</span>
                  </div>
                  <div class="row g-3">
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">BTC Balance</div>
                        <div class="metric-value" id="coldBtcBalance">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Confirmed</div>
                        <div class="metric-value" id="coldBtcConfirmed">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Unconfirmed</div>
                        <div class="metric-value" id="coldBtcUnconfirmed">Loading...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-4 mt-2">
            <div class="col-12">
              <div class="neon-panel neon-blue">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <h2 class="h5 mb-1">Quant</h2>
                      <p class="text-secondary mb-0">Research tools and signals.</p>
                    </div>
                    <div class="fs-3 text-primary">
                      <i class="bi bi-cpu"></i>
                    </div>
                  </div>
                  <div class="row g-3 mt-2 align-items-start">
                    <div class="col-12 col-lg-4">
                      <img src="{{ url_for('static', filename='images/smart-monkey.jpg') }}" alt="Smart monkey" class="bull-bear-gif quant-monkey-glow">
                    </div>
                    <div class="col-12 col-lg-8">
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>Volatility (ann.)</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantVolatilityTip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantVolatility">Loading...</div>
                          <div class="quant-tooltip" id="quantVolatilityTip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>Volatility (ann.)</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantVolatilityTipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>Max Drawdown</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantMaxDrawdownTip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantMaxDrawdown">Loading...</div>
                          <div class="quant-tooltip" id="quantMaxDrawdownTip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>Max Drawdown</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantMaxDrawdownTipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>Beta vs SPY</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantBetaTip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantBeta">Loading...</div>
                          <div class="quant-tooltip" id="quantBetaTip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>Beta vs SPY</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantBetaTipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-2">
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>Top Sector</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantTopSectorTip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantTopSector">Loading...</div>
                          <div class="quant-tooltip" id="quantTopSectorTip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>Top Sector</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantTopSectorTipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>HHI</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantHHITip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantHHI">Loading...</div>
                          <div class="quant-tooltip" id="quantHHITip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>HHI</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantHHITipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4">
                          <div class="metric-tile">
                          <div class="metric-label metric-label-info">
                            <span>Diversification Ratio</span>
                            <button class="quant-info-btn" type="button" data-tooltip-target="quantDiversificationTip">
                              <i class="bi bi-info-circle"></i>
                            </button>
                          </div>
                            <div class="metric-value" id="quantDiversification">Loading...</div>
                          <div class="quant-tooltip" id="quantDiversificationTip" data-tooltip>
                            <div class="quant-tooltip-header">
                              <span>Diversification Ratio</span>
                              <button class="quant-close-btn" type="button">Ã—</button>
                            </div>
                            <div class="quant-tooltip-body" id="quantDiversificationTipBody">Loading...</div>
                          </div>
                          </div>
                        </div>
                      </div>
                      <div class="mt-2 text-lg-end">
                        <span class="badge" id="quantLastUpdated">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <div class="mt-5">
                    <a class="btn btn-outline-primary btn-sm" href="/quant">
                      <i class="bi bi-rocket-takeoff me-1"></i>Launch Quant
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-4 mt-2">
            <div class="col-12">
              <div class="neon-panel neon-gunmetal">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <h2 class="h5 mb-1">Admin</h2>
                      <p class="text-secondary mb-0">Local-only maintenance tools.</p>
                    </div>
                  </div>
                  <button id="wipeAllButton" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash me-1"></i>Wipe All Data
                  </button>
                  <small class="text-secondary ms-2">This clears local DB data only.</small>
                  <hr class="border-secondary my-4">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <h3 class="h6 mb-1">ETF Source Registry</h3>
                      <p class="text-secondary mb-0">Auto-lookup with manual override.</p>
                    </div>
                  </div>
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-3">
                      <label class="form-label text-secondary small mb-1" for="etfSourceSymbol">Symbol</label>
                      <input id="etfSourceSymbol" class="form-control form-control-sm" placeholder="VTI" />
                    </div>
                    <div class="col-12 col-md-5">
                      <label class="form-label text-secondary small mb-1" for="etfSourceUrl">Provider URL (optional)</label>
                      <input id="etfSourceUrl" class="form-control form-control-sm" placeholder="https://..." />
                    </div>
                    <div class="col-12 col-md-2">
                      <label class="form-label text-secondary small mb-1" for="etfSourceType">Source Type</label>
                      <select id="etfSourceType" class="form-select form-select-sm">
                        <option value="">Auto</option>
                        <option value="schwab_portfolio">Schwab</option>
                        <option value="provider_csv">Provider CSV</option>
                        <option value="yahoo_top_holdings">Yahoo</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-2">
                      <button id="etfSourceSave" class="btn btn-outline-light btn-sm w-100">
                        <i class="bi bi-save2 me-1"></i>Save
                      </button>
                    </div>
                  </div>
                  <div id="etfSourceStatus" class="text-secondary small mt-2">Ready.</div>
                  <div class="table-responsive mt-3">
                    <table class="table table-dark table-striped table-sm align-middle" id="etfSourceTable">
                      <thead>
                        <tr>
                          <th>Symbol</th>
                          <th>Source Type</th>
                          <th>URL</th>
                          <th>Updated</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </body>


<script>
  const quantTooltips = Array.from(document.querySelectorAll('[data-tooltip]'));
  const quantInfoButtons = Array.from(document.querySelectorAll('.quant-info-btn'));

  function closeTooltips(exceptId) {
    quantTooltips.forEach(tip => {
      if (tip.id !== exceptId) {
        tip.classList.remove('is-open');
      }
    });
  }

  quantInfoButtons.forEach(btn => {
    btn.addEventListener('click', (event) => {
      event.stopPropagation();
      const targetId = btn.getAttribute('data-tooltip-target');
      if (!targetId) return;
      const tooltip = document.getElementById(targetId);
      if (!tooltip) return;
      const isOpen = tooltip.classList.contains('is-open');
      closeTooltips(targetId);
      tooltip.classList.toggle('is-open', !isOpen);
    });
  });

  quantTooltips.forEach(tip => {
    const closeBtn = tip.querySelector('.quant-close-btn');
    if (closeBtn) {
      closeBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        tip.classList.remove('is-open');
      });
    }
  });

  document.addEventListener('click', () => {
    closeTooltips();
  });

  const wipeBtn = document.getElementById('wipeAllButton');
  if (wipeBtn) {
    wipeBtn.addEventListener('click', () => {
      const ok = window.confirm('This will delete ALL local data (stocks, prices, Plaid items, accounts, transactions). Continue?');
      if (!ok) return;
      fetch('/admin/wipe_all', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            alert('All local data wiped.');
            window.location.reload();
          } else {
            alert('Wipe failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error('Wipe failed:', err);
          alert('Wipe failed. Check console.');
        });
    });
  }
</script>

<script>
  const etfSaveBtn = document.getElementById('etfSourceSave');
  const etfSymbolEl = document.getElementById('etfSourceSymbol');
  const etfUrlEl = document.getElementById('etfSourceUrl');
  const etfTypeEl = document.getElementById('etfSourceType');
  const etfStatusEl = document.getElementById('etfSourceStatus');
  const etfTableBody = document.querySelector('#etfSourceTable tbody');

  function renderEtfSources(items) {
    if (!etfTableBody) return;
    etfTableBody.innerHTML = '';
    if (!items || !items.length) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="4" class="text-secondary">No ETF sources yet.</td>';
      etfTableBody.appendChild(row);
      return;
    }
    items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.symbol || ''}</td>
        <td>${item.source_type || ''}</td>
        <td>${item.url || ''}</td>
        <td>${item.updated_at || ''}</td>
      `;
      etfTableBody.appendChild(row);
    });
  }

  function loadEtfSources() {
    fetch('/admin/etf_sources')
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          if (etfStatusEl) etfStatusEl.innerText = `Load failed: ${data.error}`;
          return;
        }
        renderEtfSources(data.items || []);
      })
      .catch(err => {
        if (etfStatusEl) etfStatusEl.innerText = `Load failed: ${err}`;
      });
  }

  if (etfSaveBtn) {
    etfSaveBtn.addEventListener('click', () => {
      const symbol = etfSymbolEl ? etfSymbolEl.value.trim().toUpperCase() : '';
      const url = etfUrlEl ? etfUrlEl.value.trim() : '';
      const sourceType = etfTypeEl ? etfTypeEl.value : '';
      if (!symbol) {
        if (etfStatusEl) etfStatusEl.innerText = 'Symbol is required.';
        return;
      }
      if (etfStatusEl) etfStatusEl.innerText = 'Saving...';
      fetch('/admin/etf_sources', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol, url, source_type: sourceType }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            if (etfStatusEl) etfStatusEl.innerText = `Save failed: ${data.error}`;
            return;
          }
          if (etfStatusEl) etfStatusEl.innerText = `Saved: ${data.source.source_type}`;
          if (etfUrlEl && data.source.url) {
            etfUrlEl.value = data.source.url;
          }
          loadEtfSources();
        })
        .catch(err => {
          if (etfStatusEl) etfStatusEl.innerText = `Save failed: ${err}`;
        });
    });
  }

  if (etfTableBody) {
    loadEtfSources();
  }
</script>

<script>
  const quantVolEl = document.getElementById('quantVolatility');
  const quantDdEl = document.getElementById('quantMaxDrawdown');
  const quantBetaEl = document.getElementById('quantBeta');
  const quantTopSectorEl = document.getElementById('quantTopSector');
  const quantHHIEl = document.getElementById('quantHHI');
  const quantDiversificationEl = document.getElementById('quantDiversification');
  const quantVolTipBody = document.getElementById('quantVolatilityTipBody');
  const quantDdTipBody = document.getElementById('quantMaxDrawdownTipBody');
  const quantBetaTipBody = document.getElementById('quantBetaTipBody');
  const quantTopSectorTipBody = document.getElementById('quantTopSectorTipBody');
  const quantHHITipBody = document.getElementById('quantHHITipBody');
  const quantDiversificationTipBody = document.getElementById('quantDiversificationTipBody');
  const quantUpdatedEl = document.getElementById('quantLastUpdated');
  if (
    quantVolEl && quantDdEl && quantBetaEl && quantUpdatedEl &&
    quantTopSectorEl && quantHHIEl && quantDiversificationEl &&
    quantVolTipBody && quantDdTipBody && quantBetaTipBody &&
    quantTopSectorTipBody && quantHHITipBody && quantDiversificationTipBody
  ) {
    fetch('/quant/risk_summary')
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          quantVolEl.innerText = "â€”";
          quantDdEl.innerText = "â€”";
          quantBetaEl.innerText = "â€”";
          quantTopSectorEl.innerText = "â€”";
          quantHHIEl.innerText = "â€”";
          quantDiversificationEl.innerText = "â€”";
          quantVolTipBody.innerText = "Annualized standard deviation of daily returns. Value: â€”";
          quantDdTipBody.innerText = "Worst peak-to-trough decline over the period. Value: â€”";
          quantBetaTipBody.innerText = "Sensitivity vs SPY (1.0 â‰ˆ market). Value: â€”";
          quantTopSectorTipBody.innerText = "Largest sector weight after ETF decomposition. Value: â€”";
          quantHHITipBody.innerText = "Concentration score (higher = more concentrated). Value: â€”";
          quantDiversificationTipBody.innerText = "Portfolio volatility / weighted avg single-stock volatility. Value: â€”";
          quantUpdatedEl.innerText = "Last updated: â€”";
          quantUpdatedEl.className = "badge bg-secondary-subtle text-secondary-emphasis";
          console.error("Quant risk summary error:", data.error);
          return;
        }
        const volText = data.volatility_pct !== null ? `${data.volatility_pct}%` : "â€”";
        const ddText = data.max_drawdown_pct !== null ? `${data.max_drawdown_pct}%` : "â€”";
        const betaText = data.beta !== null ? data.beta : "â€”";
        quantVolEl.innerText = volText;
        quantDdEl.innerText = ddText;
        quantBetaEl.innerText = betaText;
        if (data.top_sector && data.top_sector_pct !== null) {
          quantTopSectorEl.innerText = `${data.top_sector} (${data.top_sector_pct}%)`;
        } else {
          quantTopSectorEl.innerText = "â€”";
        }
        const topSectorText = quantTopSectorEl.innerText;
        const hhiText = data.hhi !== null ? data.hhi : "â€”";
        const divText = data.diversification_ratio !== null ? data.diversification_ratio : "â€”";
        quantHHIEl.innerText = hhiText;
        quantDiversificationEl.innerText = divText;
        const volValue = data.volatility_pct;
        const ddValue = data.max_drawdown_pct;
        const betaValue = data.beta;
        const hhiValue = data.hhi;
        const divValue = data.diversification_ratio;
        const topSectorValue = data.top_sector_pct;

        const volInterp = Number.isFinite(volValue)
          ? (volValue < 15
            ? "This is relatively calm for equities; day-to-day swings are modest."
            : volValue < 30
              ? "This is moderate volatility; expect noticeable swings."
              : volValue < 50
                ? "This is high volatility; large swings are common."
                : "This is very high volatility; results may be dominated by big moves or short samples.")
          : "Not enough data to interpret volatility yet.";

        const ddInterp = Number.isFinite(ddValue)
          ? (ddValue > -5
            ? "The worst dip was mild; drawdowns have been shallow."
            : ddValue > -15
              ? "The worst dip was moderate; typical for equity portfolios."
              : ddValue > -30
                ? "The worst dip was sizable; risk is meaningfully elevated."
                : "The worst dip was severe; this indicates a rough drawdown period.")
          : "Not enough data to interpret drawdown yet.";

        const betaInterp = Number.isFinite(betaValue)
          ? (betaValue < 0.7
            ? "This is defensive relative to SPY; it moves less than the market."
            : betaValue < 1.2
              ? "This is market-like; it moves roughly in line with SPY."
              : betaValue < 1.8
                ? "This is aggressive; it tends to move more than SPY."
                : "This is very aggressive; market moves are amplified.")
          : "Not enough data to interpret beta yet.";

        const topSectorInterp = Number.isFinite(topSectorValue)
          ? (topSectorValue < 25
            ? "Your largest sector is below 25%, suggesting broad exposure."
            : topSectorValue < 40
              ? "Your largest sector is meaningful but not dominant."
              : topSectorValue < 60
                ? "Your largest sector is dominant and could drive results."
                : "Your largest sector heavily dominates the portfolio.")
          : "Not enough data to interpret sector concentration yet.";

        const hhiInterp = Number.isFinite(hhiValue)
          ? (hhiValue >= 0.9
            ? "HHI is near 1.0, which means you are effectively fully concentrated."
            : hhiValue >= 0.3
              ? "This indicates high concentration across sectors."
              : hhiValue >= 0.15
                ? "This indicates moderate concentration."
                : "This indicates broad diversification across sectors.")
          : "Not enough data to interpret HHI yet.";

        const divInterp = Number.isFinite(divValue)
          ? (divValue < 1.05
            ? "Diversification benefits are limited; holdings move together."
            : divValue < 1.2
              ? "Some diversification benefit is present."
              : divValue < 1.5
                ? "Strong diversification benefit is present."
                : "Very strong diversification benefit; holdings offset each other.")
          : "Not enough data to interpret diversification ratio yet.";

        quantVolTipBody.innerText = `Volatility is the annualized standard deviation of daily returns. It captures how widely your portfolio tends to swing over a year and is a common proxy for overall risk.\n\nValue: ${volText}. ${volInterp}`;
        quantDdTipBody.innerText = `Max drawdown is the worst peak-to-trough decline in portfolio value over the selected period. It answers how deep the worst loss was before recovery.\n\nValue: ${ddText}. ${ddInterp}`;
        quantBetaTipBody.innerText = `Beta measures how sensitive your portfolio is to market moves, using SPY as the benchmark. A beta of 1.0 means market-like movement, below 1.0 is defensive, and above 1.0 is more aggressive.\n\nValue: ${betaText}. ${betaInterp}`;
        quantTopSectorTipBody.innerText = `Top sector shows the largest sector exposure after decomposing ETFs and mutual funds into their underlying sector weights. It highlights where your portfolio is most concentrated by industry.\n\nValue: ${topSectorText}. ${topSectorInterp}`;
        quantHHITipBody.innerText = `HHI (Herfindahl-Hirschman Index) is a concentration score computed from sector weights. Higher values mean fewer sectors dominate; lower values indicate broader diversification.\n\nValue: ${hhiText}. ${hhiInterp}`;
        quantDiversificationTipBody.innerText = `Diversification ratio compares portfolio volatility to the weighted average volatility of its holdings. Higher values indicate stronger diversification benefits across positions.\n\nValue: ${divText}. ${divInterp}`;
        if (data.last_updated) {
          const isFresh = data.fresh === true;
          quantUpdatedEl.innerText = `Last updated: ${data.last_updated}`;
          if (isFresh) {
            quantUpdatedEl.className = "badge bg-info-subtle text-info-emphasis";
            quantUpdatedEl.innerText = `Last updated: ${data.last_updated} âœ“`;
          } else {
            quantUpdatedEl.className = "badge bg-warning text-dark";
            quantUpdatedEl.innerText = `Last updated: ${data.last_updated} âœ•`;
          }
        } else {
          quantUpdatedEl.innerText = "Last updated: â€”";
          quantUpdatedEl.className = "badge bg-secondary-subtle text-secondary-emphasis";
        }
      })
      .catch(error => {
        quantVolEl.innerText = "â€”";
        quantDdEl.innerText = "â€”";
        quantBetaEl.innerText = "â€”";
        quantTopSectorEl.innerText = "â€”";
        quantHHIEl.innerText = "â€”";
        quantDiversificationEl.innerText = "â€”";
        quantUpdatedEl.innerText = "Last updated: â€”";
        quantUpdatedEl.className = "badge bg-secondary-subtle text-secondary-emphasis";
        console.error("Quant risk fetch error:", error);
      });
  }
</script>

<script>

    // Initialize Plaid Link (kept for later use)
    const linkButton = document.getElementById('linkButton');
    if (linkButton) {
        linkButton.onclick = function() {
            fetch('/create_link_token', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("ðŸ“¢ Response from Flask:", data); // Debugging

                    if (!data.link_token) {
                        console.error("ðŸš¨ Error: No link token received!", data);
                        return;
                    }

                    const handler = Plaid.create({
                        token: data.link_token,
                        onSuccess: function(public_token, metadata) {
                        // Send the public_token to your backend for exchange
                            fetch('/exchange_public_token', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                  public_token: public_token,
                                  institution_name: metadata && metadata.institution ? metadata.institution.name : null,
                                  institution_id: metadata && metadata.institution ? metadata.institution.institution_id : null
                                })
                            })
                            .then(response => response.json())
                            .then(exchangeData => {
                                console.log("Exchange response:", exchangeData);
                                return fetch('/plaid/import_holdings', { method: 'POST' });
                            })
                            .then(response => response.json())
                            .then(importData => {
                                console.log("Holdings import:", importData);
                            })
                            .catch(error => {
                                console.error("Error exchanging token:", error);
                            });
                        },
                        onExit: function(err, metadata) {
                        if (err) console.error("Plaid Link Error:", err);
                        }
                    });

                    handler.open();
                })
                .catch(error => {
                    console.error("ðŸš¨ Fetch Error:", error);
                });
        };
    }
</script>

<script>
    // Alpha Vantage widget logic (kept for later use)
    const sp500El = document.getElementById('sp500-value');
    const btcEl = document.getElementById('btc-value');
    if (sp500El && btcEl) {
        fetch('/sp500')
        .then(response => response.json())
        .then(data => {
            if (data.sp500) {
            sp500El.innerText = data.sp500;
            } else {
            sp500El.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            sp500El.innerText = "Error fetching data";
        });

        fetch('/btc')
        .then(response => response.json())
        .then(data => {
            if (data.btc) {
            btcEl.innerText = data.btc;
            } else {
            btcEl.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            btcEl.innerText = "Error fetching data";
        });
    }

    const fetchTickerBtn = document.getElementById("fetchTickerBtn");
    if (fetchTickerBtn) {
        fetchTickerBtn.addEventListener("click", function() {
            const ticker = document.getElementById("tickerInput").value.trim();
            if (!ticker) {
            alert("Please enter a ticker symbol.");
            return;
            }
            fetch('/ticker', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
            if (data.price) {
                document.getElementById("tickerPrice").innerText = data.price;
            } else {
                document.getElementById("tickerPrice").innerText = "Error fetching price";
                console.error("Error:", data.error);
            }
            })
            .catch(error => {
            console.error("Fetch error:", error);
            document.getElementById("tickerPrice").innerText = "Error fetching price";
            });
        });
    }

    const fetchCryptoBtn = document.getElementById("fetchCryptoBtn");
    if (fetchCryptoBtn) {
        fetchCryptoBtn.addEventListener("click", function() {
            const crypto = document.getElementById("cryptoInput").value.trim();
            if (!crypto) {
            alert("Please enter a crypto ticker symbol.");
            return;
            }
            fetch('/crypto', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: crypto })
            })
            .then(response => response.json())
            .then(data => {
            if (data.price) {
                document.getElementById("cryptoPrice").innerText = data.price;
            } else {
                document.getElementById("cryptoPrice").innerText = "Error fetching price";
            }
            })
            .catch(error => {
            console.error("Crypto fetch error:", error);
            document.getElementById("cryptoPrice").innerText = "Error fetching price";
            });
        });
    }
</script>

<script>
    // Finnhub widget logic (kept for later use)
    const finnhubValue = document.getElementById('finnhub-value');
    if (finnhubValue) {
        fetch('/finnhub')
        .then(response => response.json())
        .then(data => {
            if(data.price){
            finnhubValue.innerText = data.price;
            } else {
            finnhubValue.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Finnhub fetch error:", error);
            finnhubValue.innerText = "Error fetching data";
        });
    }

    const finnhubBtn = document.getElementById("finnFetchTickerBtn");
    if (finnhubBtn) {
        finnhubBtn.addEventListener("click", function() {
        const ticker = document.getElementById("finnTickerInput").value.trim();
        if (!ticker) {
            alert("Please enter a stock ticker symbol.");
            return;
        }
        fetch('/stock', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.price) {
            document.getElementById("finnTickerPrice").innerText = data.price;
            } else {
            document.getElementById("finnTickerPrice").innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Stock fetch error:", error);
            document.getElementById("finnTickerPrice").innerText = "Error fetching data";
        });
        });
    }


const geckoBtcValue = document.getElementById("coingecko-btc-value");
if (geckoBtcValue) {
    fetch('/coingeckoBtc', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})  // No ticker needed since it's hardcoded to BTC
    })
    .then(response => response.json())
    .then(data => {
        if (data.price) {
            console.log("BTC Price:", data.price);
            geckoBtcValue.innerText = data.price;
        } else {
            console.error("Error:", data.error);
        }
    })
    .catch(error => console.error("Fetch error:", error));
}

const geckoBtn = document.getElementById("geckoFetchCryptoBtn");
if (geckoBtn) {
    geckoBtn.addEventListener("click", function() {
        const ticker = document.getElementById("geckoCryptoInput").value.trim();
        if (!ticker) {
        alert("Please enter a crypto ticker symbol.");
        return;
        }
        fetch('/coingecko', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
        if (data.price) {
            document.getElementById("geckoCryptoPrice").innerText = data.price;
        } else {
            document.getElementById("geckoCryptoPrice").innerText = "Error fetching data";
            console.error("Crypto fetch error:", data.error);
        }
        })
        .catch(error => {
        console.error("Crypto fetch error:", error);
        document.getElementById("geckoCryptoPrice").innerText = "Error fetching data";
        });
    });
}



    // fetch('/binanceBtc')
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.btc) {
    //         document.getElementById('binance-btc-value').innerText = data.btc;
    //         } else {
    //         document.getElementById('binance-btc-value').innerText = "Error fetching data";
    //         }
    //     })
    //     .catch(error => {
    //         console.error("Error:", error);
    //         document.getElementById('binance-btc-value').innerText = "Error fetching data";
    //     });

    // // Crypto price fetch
    // document.getElementById("binanceFetchCryptoBtn").addEventListener("click", function() {
    //   const ticker = document.getElementById("binanceCryptoInput").value.trim();
    //   if (!ticker) {
    //     alert("Please enter a crypto ticker symbol.");
    //     return;
    //   }
    //   fetch('/binanceCrypto', {
    //     method: "POST",
    //     headers: { "Content-Type": "application/json" },
    //     body: JSON.stringify({ ticker: ticker })
    //   })
    //   .then(response => response.json())
    //   .then(data => {
    //     if (data.price) {
    //       document.getElementById("binanceCryptoPrice").innerText = data.price;
    //     } else {
    //       document.getElementById("binanceCryptoPrice").innerText = "Error fetching data";
    //     }
    //   })
    //   .catch(error => {
    //     console.error("Crypto fetch error:", error);
    //     document.getElementById("binanceCryptoPrice").innerText = "Error fetching data";
    //   });
    // });
  </script>

  <script>
      // Fetch the current block count from the Umbrel node API endpoint
  fetch('/umbrel/blockcount')
    .then(response => response.json())
    .then(data => {
      if (data.block_count !== undefined) {
        document.getElementById('blockcount').innerText = data.block_count;
      } else {
        document.getElementById('blockcount').innerText = "Error fetching data";
        console.error("Error fetching Umbrel metrics:", data.error);
      }
    })
    .catch(error => {
      console.error("Error fetching Umbrel metrics:", error);
      document.getElementById('blockcount').innerText = "Error fetching data";
    });

    // Fetch network hash rate
    fetch('/umbrel/networkhashps')
      .then(response => response.json())
      .then(data => {
        document.getElementById('networkhashps').innerText = data.networkhashps || "Error";
      })
      .catch(error => {
        console.error(error);
        document.getElementById('networkhashps').innerText = "Error";
      });

    // Fetch mempool info (showing number of transactions in mempool)
    fetch('/umbrel/mempoolinfo')
      .then(response => response.json())
      .then(data => {
        if (data.mempoolinfo && data.mempoolinfo.size !== undefined) {
          document.getElementById('mempoolinfo').innerText = data.mempoolinfo.size;
        } else {
          document.getElementById('mempoolinfo').innerText = "Error";
        }
      })
      .catch(error => {
        console.error(error);
        document.getElementById('mempoolinfo').innerText = "Error";
      });

    // Fetch estimatesmartfee (showing fee rate)
    fetch('/umbrel/estimatesmartfee')
      .then(response => response.json())
      .then(data => {
        if (data.estimatesmartfee && data.estimatesmartfee.feerate !== undefined) {
          document.getElementById('estimatesmartfee').innerText = data.estimatesmartfee.feerate;
        } else {
          document.getElementById('estimatesmartfee').innerText = "Error";
        }
      })
      .catch(error => {
        console.error(error);
        document.getElementById('estimatesmartfee').innerText = "Error";
      });


    // Fetch Lightning info from the Umbrel node
    fetch('/umbrel/lightning/getinfo')
      .then(response => response.json())
      .then(data => {
          if (data.error) {
              document.getElementById('lightningAlias').innerText = "Error";
              document.getElementById('lightningBlockHeight').innerText = "Error";
              document.getElementById('lightningChannels').innerText = "Error";
              console.error("Error fetching Lightning metrics:", data.error);
          } else {
              // For LND getinfo, common fields include 'alias', 'block_height', and sometimes 'num_active_channels'
              document.getElementById('lightningAlias').innerText = data.alias || "N/A";
              document.getElementById('lightningBlockHeight').innerText = data.block_height || "N/A";
              document.getElementById('lightningChannels').innerText = data.num_active_channels || "N/A";
          }
      })
      .catch(error => {
          console.error("Error fetching Lightning metrics:", error);
          document.getElementById('lightningAlias').innerText = "Error";
          document.getElementById('lightningBlockHeight').innerText = "Error";
          document.getElementById('lightningChannels').innerText = "Error";
    });
  </script>

  <script>
    fetch('/btc/wallet_summary')
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('coldStorageStatus').innerText = "Not configured";
          document.getElementById('coldBtcBalance').innerText = "â€”";
          document.getElementById('coldBtcConfirmed').innerText = "â€”";
          document.getElementById('coldBtcUnconfirmed').innerText = "â€”";
          console.error("Cold storage error:", data.error);
          return;
        }
        document.getElementById('coldBtcBalance').innerText = `${data.balance_btc.toFixed(8)} BTC`;
        document.getElementById('coldBtcConfirmed').innerText = `${data.confirmed_btc.toFixed(8)} BTC`;
        document.getElementById('coldBtcUnconfirmed').innerText = `${data.unconfirmed_btc.toFixed(8)} BTC`;
      })
      .catch(error => {
        document.getElementById('coldStorageStatus').innerText = "Offline";
        document.getElementById('coldBtcBalance').innerText = "â€”";
        document.getElementById('coldBtcConfirmed').innerText = "â€”";
        document.getElementById('coldBtcUnconfirmed').innerText = "â€”";
        console.error("Cold storage fetch error:", error);
      });
  </script>

  <script>
    // fetch('/nownodes/eth_blocknumber')
    //   .then(response => response.json())
    //   .then(data => {
    //       if (data.block_number !== undefined) {
    //           document.getElementById('ethBlockNumber').innerText = data.block_number;
    //       } else {
    //           document.getElementById('ethBlockNumber').innerText = "Error fetching data";
    //           console.error("Error fetching NOWNODES metrics:", data.error);
    //       }
    //   })
    //   .catch(error => {
    //       console.error("Error fetching NOWNODES metrics:", error);
    //       document.getElementById('ethBlockNumber').innerText = "Error fetching data";
    //   });
  </script>
</html>
