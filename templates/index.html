<!DOCTYPE html>
  <!-- TEMPLATE VERSION: neon-v2 -->
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>FinanceTracker</title>
        <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/darkly/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}">
        
    </head>
    <body>
        <div class="container py-4">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h1 class="h3 mb-1">FinanceTracker</h1>
              <p class="text-secondary mb-0">Dark finance dashboard</p>
            </div>
          </div>

          <div class="row g-4">
            <div class="col-12 col-lg-5">
              <div class="neon-panel neon-green h-100" id="stocksCard">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h2 class="h4 mb-1">Stocks</h2>
                      <p class="text-secondary mb-0">Track positions, value, and performance.</p>
                    </div>
                    <div class="fs-3 text-success">
                      <i class="bi bi-graph-up-arrow"></i>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-3 mb-3 bull-bear-actions">
                    <img src="{{ url_for('static', filename='images/bull-bear.gif') }}" alt="Bull and bear" class="bull-bear-gif">
                    <button class="btn btn-success bull-bear-btn" onclick="window.location.href='/dashboard/stocks_dash/'">
                      <i class="bi bi-bar-chart-line me-2"></i>View Stocks
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-7">
              <div class="neon-panel neon-yellow h-100" id="cryptoCorner">
                <div class="neon-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h2 class="h4 mb-1">Crypto Corner</h2>
                      <p class="text-secondary mb-0">Umbrel node health & Lightning status.</p>
                    </div>
                    <div class="fs-3 text-warning">
                      <i class="bi bi-currency-bitcoin"></i>
                      <i class="bi bi-coin ms-1"></i>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Block Count</div>
                        <div class="metric-value" id="blockcount">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Network Hash Rate</div>
                        <div class="metric-value" id="networkhashps">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Mempool Txns</div>
                        <div class="metric-value" id="mempoolinfo">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="metric-tile">
                        <div class="metric-label">Fee Estimate (6 blocks)</div>
                        <div class="metric-value" id="estimatesmartfee">Loading...</div>
                      </div>
                    </div>
                  </div>

                  <hr class="border-secondary my-4">

                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h3 class="h5 mb-0">Umbrel Lightning</h3>
                    <span class="badge bg-warning-subtle text-warning-emphasis">Live</span>
                  </div>
                  <div class="row g-3">
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Node Alias</div>
                        <div class="metric-value" id="lightningAlias">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Block Height</div>
                        <div class="metric-value" id="lightningBlockHeight">Loading...</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="metric-tile">
                        <div class="metric-label">Active Channels</div>
                        <div class="metric-value" id="lightningChannels">Loading...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </body>


<script>

    // Initialize Plaid Link (kept for later use)
    const linkButton = document.getElementById('linkButton');
    if (linkButton) {
        linkButton.onclick = function() {
            fetch('/create_link_token', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("ðŸ“¢ Response from Flask:", data); // Debugging

                    if (!data.link_token) {
                        console.error("ðŸš¨ Error: No link token received!", data);
                        return;
                    }

                    const handler = Plaid.create({
                        token: data.link_token,
                        onSuccess: function(public_token, metadata) {
                        // Send the public_token to your backend for exchange
                            fetch('/exchange_public_token', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ public_token: public_token })
                            })
                            .then(response => response.json())
                            .then(exchangeData => {
                                console.log("Exchange response:", exchangeData);
                                // Now you have the access token; you can call other endpoints if needed
                            })
                            .catch(error => {
                                console.error("Error exchanging token:", error);
                            });
                        },
                        onExit: function(err, metadata) {
                        if (err) console.error("Plaid Link Error:", err);
                        }
                    });

                    handler.open();
                })
                .catch(error => {
                    console.error("ðŸš¨ Fetch Error:", error);
                });
        };
    }
</script>

<script>
    // Alpha Vantage widget logic (kept for later use)
    const sp500El = document.getElementById('sp500-value');
    const btcEl = document.getElementById('btc-value');
    if (sp500El && btcEl) {
        fetch('/sp500')
        .then(response => response.json())
        .then(data => {
            if (data.sp500) {
            sp500El.innerText = data.sp500;
            } else {
            sp500El.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            sp500El.innerText = "Error fetching data";
        });

        fetch('/btc')
        .then(response => response.json())
        .then(data => {
            if (data.btc) {
            btcEl.innerText = data.btc;
            } else {
            btcEl.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            btcEl.innerText = "Error fetching data";
        });
    }

    const fetchTickerBtn = document.getElementById("fetchTickerBtn");
    if (fetchTickerBtn) {
        fetchTickerBtn.addEventListener("click", function() {
            const ticker = document.getElementById("tickerInput").value.trim();
            if (!ticker) {
            alert("Please enter a ticker symbol.");
            return;
            }
            fetch('/ticker', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
            if (data.price) {
                document.getElementById("tickerPrice").innerText = data.price;
            } else {
                document.getElementById("tickerPrice").innerText = "Error fetching price";
                console.error("Error:", data.error);
            }
            })
            .catch(error => {
            console.error("Fetch error:", error);
            document.getElementById("tickerPrice").innerText = "Error fetching price";
            });
        });
    }

    const fetchCryptoBtn = document.getElementById("fetchCryptoBtn");
    if (fetchCryptoBtn) {
        fetchCryptoBtn.addEventListener("click", function() {
            const crypto = document.getElementById("cryptoInput").value.trim();
            if (!crypto) {
            alert("Please enter a crypto ticker symbol.");
            return;
            }
            fetch('/crypto', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: crypto })
            })
            .then(response => response.json())
            .then(data => {
            if (data.price) {
                document.getElementById("cryptoPrice").innerText = data.price;
            } else {
                document.getElementById("cryptoPrice").innerText = "Error fetching price";
            }
            })
            .catch(error => {
            console.error("Crypto fetch error:", error);
            document.getElementById("cryptoPrice").innerText = "Error fetching price";
            });
        });
    }
</script>

<script>
    // Finnhub widget logic (kept for later use)
    const finnhubValue = document.getElementById('finnhub-value');
    if (finnhubValue) {
        fetch('/finnhub')
        .then(response => response.json())
        .then(data => {
            if(data.price){
            finnhubValue.innerText = data.price;
            } else {
            finnhubValue.innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Finnhub fetch error:", error);
            finnhubValue.innerText = "Error fetching data";
        });
    }

    const finnhubBtn = document.getElementById("finnFetchTickerBtn");
    if (finnhubBtn) {
        finnhubBtn.addEventListener("click", function() {
        const ticker = document.getElementById("finnTickerInput").value.trim();
        if (!ticker) {
            alert("Please enter a stock ticker symbol.");
            return;
        }
        fetch('/stock', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.price) {
            document.getElementById("finnTickerPrice").innerText = data.price;
            } else {
            document.getElementById("finnTickerPrice").innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Stock fetch error:", error);
            document.getElementById("finnTickerPrice").innerText = "Error fetching data";
        });
        });
    }


const geckoBtcValue = document.getElementById("coingecko-btc-value");
if (geckoBtcValue) {
    fetch('/coingeckoBtc', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})  // No ticker needed since it's hardcoded to BTC
    })
    .then(response => response.json())
    .then(data => {
        if (data.price) {
            console.log("BTC Price:", data.price);
            geckoBtcValue.innerText = data.price;
        } else {
            console.error("Error:", data.error);
        }
    })
    .catch(error => console.error("Fetch error:", error));
}

const geckoBtn = document.getElementById("geckoFetchCryptoBtn");
if (geckoBtn) {
    geckoBtn.addEventListener("click", function() {
        const ticker = document.getElementById("geckoCryptoInput").value.trim();
        if (!ticker) {
        alert("Please enter a crypto ticker symbol.");
        return;
        }
        fetch('/coingecko', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
        if (data.price) {
            document.getElementById("geckoCryptoPrice").innerText = data.price;
        } else {
            document.getElementById("geckoCryptoPrice").innerText = "Error fetching data";
            console.error("Crypto fetch error:", data.error);
        }
        })
        .catch(error => {
        console.error("Crypto fetch error:", error);
        document.getElementById("geckoCryptoPrice").innerText = "Error fetching data";
        });
    });
}



    // fetch('/binanceBtc')
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.btc) {
    //         document.getElementById('binance-btc-value').innerText = data.btc;
    //         } else {
    //         document.getElementById('binance-btc-value').innerText = "Error fetching data";
    //         }
    //     })
    //     .catch(error => {
    //         console.error("Error:", error);
    //         document.getElementById('binance-btc-value').innerText = "Error fetching data";
    //     });

    // // Crypto price fetch
    // document.getElementById("binanceFetchCryptoBtn").addEventListener("click", function() {
    //   const ticker = document.getElementById("binanceCryptoInput").value.trim();
    //   if (!ticker) {
    //     alert("Please enter a crypto ticker symbol.");
    //     return;
    //   }
    //   fetch('/binanceCrypto', {
    //     method: "POST",
    //     headers: { "Content-Type": "application/json" },
    //     body: JSON.stringify({ ticker: ticker })
    //   })
    //   .then(response => response.json())
    //   .then(data => {
    //     if (data.price) {
    //       document.getElementById("binanceCryptoPrice").innerText = data.price;
    //     } else {
    //       document.getElementById("binanceCryptoPrice").innerText = "Error fetching data";
    //     }
    //   })
    //   .catch(error => {
    //     console.error("Crypto fetch error:", error);
    //     document.getElementById("binanceCryptoPrice").innerText = "Error fetching data";
    //   });
    // });
  </script>

  <script>
      // Fetch the current block count from the Umbrel node API endpoint
  fetch('/umbrel/blockcount')
    .then(response => response.json())
    .then(data => {
      if (data.block_count !== undefined) {
        document.getElementById('blockcount').innerText = data.block_count;
      } else {
        document.getElementById('blockcount').innerText = "Error fetching data";
        console.error("Error fetching Umbrel metrics:", data.error);
      }
    })
    .catch(error => {
      console.error("Error fetching Umbrel metrics:", error);
      document.getElementById('blockcount').innerText = "Error fetching data";
    });

    // Fetch network hash rate
    fetch('/umbrel/networkhashps')
      .then(response => response.json())
      .then(data => {
        document.getElementById('networkhashps').innerText = data.networkhashps || "Error";
      })
      .catch(error => {
        console.error(error);
        document.getElementById('networkhashps').innerText = "Error";
      });

    // Fetch mempool info (showing number of transactions in mempool)
    fetch('/umbrel/mempoolinfo')
      .then(response => response.json())
      .then(data => {
        if (data.mempoolinfo && data.mempoolinfo.size !== undefined) {
          document.getElementById('mempoolinfo').innerText = data.mempoolinfo.size;
        } else {
          document.getElementById('mempoolinfo').innerText = "Error";
        }
      })
      .catch(error => {
        console.error(error);
        document.getElementById('mempoolinfo').innerText = "Error";
      });

    // Fetch estimatesmartfee (showing fee rate)
    fetch('/umbrel/estimatesmartfee')
      .then(response => response.json())
      .then(data => {
        if (data.estimatesmartfee && data.estimatesmartfee.feerate !== undefined) {
          document.getElementById('estimatesmartfee').innerText = data.estimatesmartfee.feerate;
        } else {
          document.getElementById('estimatesmartfee').innerText = "Error";
        }
      })
      .catch(error => {
        console.error(error);
        document.getElementById('estimatesmartfee').innerText = "Error";
      });


    // Fetch Lightning info from the Umbrel node
    fetch('/umbrel/lightning/getinfo')
      .then(response => response.json())
      .then(data => {
          if (data.error) {
              document.getElementById('lightningAlias').innerText = "Error";
              document.getElementById('lightningBlockHeight').innerText = "Error";
              document.getElementById('lightningChannels').innerText = "Error";
              console.error("Error fetching Lightning metrics:", data.error);
          } else {
              // For LND getinfo, common fields include 'alias', 'block_height', and sometimes 'num_active_channels'
              document.getElementById('lightningAlias').innerText = data.alias || "N/A";
              document.getElementById('lightningBlockHeight').innerText = data.block_height || "N/A";
              document.getElementById('lightningChannels').innerText = data.num_active_channels || "N/A";
          }
      })
      .catch(error => {
          console.error("Error fetching Lightning metrics:", error);
          document.getElementById('lightningAlias').innerText = "Error";
          document.getElementById('lightningBlockHeight').innerText = "Error";
          document.getElementById('lightningChannels').innerText = "Error";
    });
  </script>

  <script>
    // fetch('/nownodes/eth_blocknumber')
    //   .then(response => response.json())
    //   .then(data => {
    //       if (data.block_number !== undefined) {
    //           document.getElementById('ethBlockNumber').innerText = data.block_number;
    //       } else {
    //           document.getElementById('ethBlockNumber').innerText = "Error fetching data";
    //           console.error("Error fetching NOWNODES metrics:", data.error);
    //       }
    //   })
    //   .catch(error => {
    //       console.error("Error fetching NOWNODES metrics:", error);
    //       document.getElementById('ethBlockNumber').innerText = "Error fetching data";
    //   });
  </script>
</html>
