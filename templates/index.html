<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Plaid Integration</title>
        <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}">
        
    </head>
    <body>
        <div class="container">
          <!-- First Card: Plaid Integration & Dashboard -->
          <div class="card">
            <h1>Plaid Integration</h1>
            <p>Click the button below to connect a bank account:</p>
            <button id="linkButton">Connect a bank account</button>
            <hr>
            <h1>Dashboard</h1>
            <p>View your financial metrics:</p>
            <button onclick="window.location.href='/dashboard/'">View Metrics</button>
          </div>
          
          <!-- Second Card: Alpha Vantage Data -->
          <div id="AlphaVantageData" class="card">
            <h1>Alpha Vantage Data</h1>
            <div>
              <h2>S&P 500: <span id="sp500-value">Loading...</span></h2>
              <h2>BTC: <span id="btc-value">Loading...</span></h2>
            </div>
            <hr>
            <div>
              <h2>Get Stock Price</h2>
              <input type="text" id="tickerInput" placeholder="e.g., NVDA">
              <button id="fetchTickerBtn">Get Price</button>
              <p>Price: <span id="tickerPrice">N/A</span></p>
            </div>
            <hr>
            <div>
              <h2>Get Crypto Price</h2>
              <input type="text" id="cryptoInput" placeholder="Enter crypto ticker (e.g., ETH)">
              <button id="fetchCryptoBtn">Get Crypto Price</button>
              <p>Crypto Price: <span id="cryptoPrice">N/A</span></p>
            </div>
          </div>
          
          <div class="card" id="FinnhubData">
            <h1>Finnhub Data</h1>
            <div>
              <h2>S&P 500 (SPY): <span id="finnhub-value">Loading...</span></h2>
            </div>
          </div>
        

        </div>
    </body>

    <!-- <script>
        // Initialize Plaid Link
        document.getElementById('linkButton').onclick = function() {
            fetch('/create_link_token', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("ðŸ“¢ Response from Flask:", data); // Debugging
    
                    if (!data.link_token) {
                        console.error("ðŸš¨ Error: No link token received!", data);
                        return;
                    }
    
                    const handler = Plaid.create({
                        token: data.link_token,
                        onSuccess: function(public_token, metadata) {
                        // Send the public_token to your backend for exchange
                            fetch('/exchange_public_token', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ public_token: public_token })
                            })
                            .then(response => response.json())
                            .then(exchangeData => {
                                console.log("Exchange response:", exchangeData);
                                // Now you have the access token; you can call other endpoints if needed
                            })
                            .catch(error => {
                                console.error("Error exchanging token:", error);
                            });
                        },
                        onExit: function(err, metadata) {
                        if (err) console.error("Plaid Link Error:", err);
                        }
                    });
    
                    handler.open();
                })
                .catch(error => {
                    console.error("ðŸš¨ Fetch Error:", error);
                });
        };


        // Fetch the S&P 500 value from the server
        fetch('/sp500')
        .then(response => response.json())
        .then(data => {
            if (data.sp500) {
            document.getElementById('sp500-value').innerText = data.sp500;
            } else {
            document.getElementById('sp500-value').innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('sp500-value').innerText = "Error fetching data";
        });

         // Fetch BTC value
        fetch('/btc')
        .then(response => response.json())
        .then(data => {
            if (data.btc) {
            document.getElementById('btc-value').innerText = data.btc;
            } else {
            document.getElementById('btc-value').innerText = "Error fetching data";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('btc-value').innerText = "Error fetching data";
        });


         // Ticker price fetch functionality
    document.getElementById("fetchTickerBtn").addEventListener("click", function() {
      const ticker = document.getElementById("tickerInput").value.trim();
      if (!ticker) {
        alert("Please enter a ticker symbol.");
        return;
      }
      fetch('/ticker', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticker: ticker })
      })
      .then(response => response.json())
      .then(data => {
        if (data.price) {
          document.getElementById("tickerPrice").innerText = data.price;
        } else {
          document.getElementById("tickerPrice").innerText = "Error fetching price";
          console.error("Error:", data.error);
        }
      })
      .catch(error => {
        console.error("Fetch error:", error);
        document.getElementById("tickerPrice").innerText = "Error fetching price";
      });
    });


        // Crypto price fetch functionality
    document.getElementById("fetchCryptoBtn").addEventListener("click", function() {
      const crypto = document.getElementById("cryptoInput").value.trim();
      if (!crypto) {
        alert("Please enter a crypto ticker symbol.");
        return;
      }
      fetch('/crypto', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticker: crypto })
      })
      .then(response => response.json())
      .then(data => {
        if (data.price) {
          document.getElementById("cryptoPrice").innerText = data.price;
        } else {
          document.getElementById("cryptoPrice").innerText = "Error fetching price";
        }
      })
      .catch(error => {
        console.error("Crypto fetch error:", error);
        document.getElementById("cryptoPrice").innerText = "Error fetching price";
      });
    });
    </script> -->

<script>
    // Fetch Finnhub data from our endpoint and update the card
    fetch('/finnhub')
      .then(response => response.json())
      .then(data => {
        if(data.price){
          document.getElementById('finnhub-value').innerText = data.price;
        } else {
          document.getElementById('finnhub-value').innerText = "Error fetching data";
        }
      })
      .catch(error => {
        console.error("Finnhub fetch error:", error);
        document.getElementById('finnhub-value').innerText = "Error fetching data";
      });
  </script>
</html>
